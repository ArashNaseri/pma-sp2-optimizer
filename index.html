<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>PMA-SP2 Optimizer</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Load styles -->
  <link href="style.css" rel="stylesheet">
</head>

<body>

  <div class="main" style="padding-bottom: 50px;margin-top: 90px;">

    <h1>PMA-SP2 Optimizer</h1>

    <p>
      This simple web app is designed to estimate the optimal experimental
      parameters for tandem PMA-SP2 experiments. The app uses data from
      <a href="#">Naseri et al. (2021)</a>.
    </p>

    <p>
      <img src="imgs/experiment.svg" style="width:100%;max-width:550px;margin-top:10px;">
    </p>

    <p>
      Optimal experimental parameters are chosen as the minimum
      simulated error for a specific range about those chosen input parameters.
      For the number concentration, the range is up and down by a factor of sqrt(10),
      thus spanning an interval of an order of magnitude. For time, the app considers
      any simulation with a time below that specified. In other words, if the
      optimal simulation occurs in half the time, that simulation is shown
      in the output. For the correlation, specifying the width of the m<sub>p</sub>-m<sub>rBC</sub>
      distribution, the range if shown explicitly in the dropdown menu.
    </p>

    <h2>Inputs</h2>

    <p>
      <div class="control">
        <div class="control-label">No. concentration (N<sub>tot</sub>)
        <span class="control-unit">#/cm<sup>3</sup></span></div> <br>
        <input class="textinput" id="Ntot_in" type="number" min="1" max="100000" value="3162.3"> <br>
        <div class="control-unit">
          (<div id="Ntot_in_down" style="display:inline;">1000</div> to
          <div id="Ntot_in_up" style="display:inline;">10000</div>
          #/cm<sup>3</sup>)
        </div>
      </div>

      <div class="control">
        <div class="control-label">Time (t)
        <span class="control-unit">hrs</span></div> <br>
        <input class="textinput" id="time_in" type="number" min="0.01" max="10" value="1.2">
        <div class="control-unit">
          (Maximum is 10 hrs)
        </div>
      </div>

      <br>

      <div class="control">
        <div class="control-label">Correlation (R<sub>12</sub>)
        <span class="control-unit">[0,1]</span></div> <br>
        <select id="R12_in">
          <option value="0.00,0.40">< 0.40</option>
          <option value="0.40,0.55">0.40 - 0.55</option>
          <option value="0.55,0.75">0.55 - 0.75</option>
          <option value="0.75,0.90">0.75 - 0.90</option>
          <option value="0.90,0.95">0.90 - 0.95</option>
          <option value="0.95,0.98">0.95 - 0.98</option>
          <option value="0.98,1.00">> 0.98</option>
        </select>

        <br>

        <!-- Phantom width image. Replaced accordingly in script. -->
        <div>
          <img src="imgs/0.png" id="dist_img" style="height:100px;border:0.8px solid #333;border-radius:3pt;margin-top:3px;">
        </div>
      </div>
    </p>

    <h2>Recommended parameters</h2>

    Lowest error of <div style="display:inline;" id="no_out"></div> simulations

    <p>
      <div class="out">
        <div class="control-label">Resolution (R<sub>m</sub>)</div> <br>
        <div class="textoutput" id="Rm_out"></div>
      </div>

      <div class="out">
        <div class="control-label">No. of PMA setpoints per decade (n<sub>c</sub>')
        <span class="control-unit">#</span></div> <br>
        <div class="textoutput" id="nc_out"></div>
      </div>

      <div class="out">
        <div class="control-label">No. of SP2 bins per decade (n<sub>s</sub>')
        <span class="control-unit">#</span></div> <br>
        <div class="textoutput" id="ns_out"></div>
      </div>

      <div class="out">
        <div class="control-label">SP2 counts / PMA setpoint (N<sub>s</sub>)
        <span class="control-unit">#</span></div> <br>
        <div class="textoutput" id="Ns0_out"></div>
      </div>

      <br>

      <div class="out">
        <div class="control-label">Actual time (t)
        <span class="control-unit">hrs</span></div> <br>
        <div class="textoutput" id="time_out"></div>
      </div>

      <div class="out">
        <div class="control-label">Actual correlation (R<sub>12</sub>)
        <span class="control-unit">[0,1]</span></div> <br>
        <div class="textoutput" id="R12_out"></div>
      </div>

      <br>

      <div class="out">
        <div class="control-label">Error
        <span class="control-unit"></span></div> <br>
        <div class="textoutput" id="err_out" style="color:#FF6961;"></div>
      </div>
    </p>

  </div>

  <!-- Read in data as a script -->
  <script src="js/mcmc.js"></script>

  <script>

    /* Reorg. into a set of arrays */
    Rm = [];
    ns = []; nc = [];
    Ns = []; Ntot = []; Ns_avg = [];
    R12 = [];
    time = []; lam = [];
    err = [];
    for (ii = 0; ii < data.length; ii++) {
      Rm.push(data[ii].Rm);
      ns.push(data[ii].ns);
      nc.push(data[ii].nc);
      Ns.push(data[ii].Ns);
      Ntot.push(data[ii].Ntot);
      Ns_avg.push(data[ii].Ns_avg);
      R12.push(data[ii].R12);
      time.push(data[ii].time);
      lam.push(data[ii].Lambda);
      err.push(data[ii].Error);
    }

    /* Factor up and down for Ntot. 3.16 ~ sqrt(10) to span one order of magnitude */
    var a_factor = Math.sqrt(10);

    /* Function to filter out based on Ntot */
    function filterA(Ntot, a, time, b, R12, c, vec) {

      /* Filter by Ntot */
      /* Note a_factor is adopted from variable outside of function above */
      outa = []; outt = []; outR1 = []
      for (ii = 0; ii < Ntot.length; ii++) {
        if ((Ntot[ii] <= (a * a_factor)) && (Ntot[ii] >= (a / a_factor))) {
          outa.push(vec[ii]);
          outt.push(time[ii]);
          outR1.push(R12[ii]);
        }
      }

      /* Filter by time */
      outb = []; outR2 = [];
      for (tt = 0; tt < outt.length; tt++) {
        if (outt[tt] <= (b * 60 * 60)) {
          outb.push(outa[tt]);
          outR2.push(outR1[tt])
        }
      }

      /* Filter by R12 */
      c = c.split(','); /* Interpret select value */
      c1 = parseFloat(c[0]);
      c2 = parseFloat(c[1]);
      out = [];
      for (rr = 0; rr < outR2.length; rr++) {
        if ((outR2[rr] > c1) && (outR2[rr] <= c2)) {
          out.push(outb[rr]);
        }
      }

      if (out.length == []) {
        out = "-";
      }

      return out;
    }


    /* Function to get the smallest index. */
    /* Used to get smallest error */
    function indexOfSmallest(a) {
      var lowest = 0;
      for (var ii = 1; ii < a.length; ii++) {
        if (a[ii] < a[lowest]) lowest = ii;
      }
      return lowest;
    }

    /* Function to get the largest index. */
    /* Used to get largest of array */
    function indexOfLargest(a) {
      var largest = 0;
      for (var ii = 1; ii < a.length; ii++) {
        if (a[ii] > a[largest]) largest = ii;
      }
      return largest;
    }


    /* Function to update results */
    function update() {

      a = document.getElementById("Ntot_in").value;
      b = document.getElementById("time_in").value;
      c = document.getElementById("R12_in").value;

      err0 = filterA(Ntot, a, time, b, R12, c, err);

      console.log(err0.length); /* number of simulations considered */

      /* Update range for Ntot. */
      document.getElementById("Ntot_in_down").innerHTML = (a / a_factor).toExponential(1);
      document.getElementById("Ntot_in_up").innerHTML = (a * a_factor).toExponential(1);

      document.getElementById("no_out").innerHTML = err0.length.toString();
      if (err0 == "-") {  /* in this case, correct to zero */
        document.getElementById("no_out").innerHTML = "0";
      }

      /* Index in Ntot-, time-, R12-selected array */
      idx = indexOfSmallest(err0);

      /* Update the corresponding outputs */
      err0 = err0[idx];
      document.getElementById("err_out").innerHTML = err0.toString().substr(0,5);

      Rm0 = filterA(Ntot, a, time, b, R12, c, Rm)[idx];
      document.getElementById("Rm_out").innerHTML = Rm0.toString().substr(0,5);

      nc0 = filterA(Ntot, a, time, b, R12, c, nc)[idx];
      document.getElementById("nc_out").innerHTML = nc0.toString().substr(0,5);

      ns0 = filterA(Ntot, a, time, b, R12, c, ns)[idx];
      document.getElementById("ns_out").innerHTML = ns0.toString().substr(0,5);

      Ns0 = filterA(Ntot, a, time, b, R12, c, Ns)[idx];
      document.getElementById("Ns0_out").innerHTML = Ns0.toString().substr(0,5);

      time0 = filterA(Ntot, a, time, b, R12, c, time)[idx];
      if (time0 == "-") {  /* because of /60, explicitly check for "-" returned */
        document.getElementById("time_out").innerHTML = "-";
      } else {
        document.getElementById("time_out").innerHTML = (time0 / 60 / 60).toString().substr(0,5);
      }

      R120 = filterA(Ntot, a, time, b, R12, c, R12)[idx];
      document.getElementById("R12_out").innerHTML = R120.toString().substr(0,5);

      c = c.split(','); /* Interpret select value */
      c1 = parseFloat(c[0]);
      document.getElementById("dist_img").src = "imgs/" + c1.toString().substr(0,4) + ".png";
    }

    update();
    document.getElementById("Ntot_in").addEventListener("change", update);
    document.getElementById("time_in").addEventListener("change", update);
    document.getElementById("R12_in").addEventListener("change", update);

  </script>


  <!-- Footer -->
  <div class="footer">
    <div class="main">
      <p>
        Created by
        <a href="#">Arash Naseri</a>
        and
        <a href="github.com/tsipkens">Timothy Sipkens</a>
        at the University of Alberta.
      </p>
    </div>
  </div>

</body>
